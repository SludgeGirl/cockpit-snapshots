import React, { useCallback, useMemo, useState } from 'react';

import { Button, DropdownItem, Modal, ModalBody, ModalFooter, ModalHeader, PageSection, Stack, Tooltip } from '@patternfly/react-core';
import { Card, CardBody, CardHeader, CardTitle } from "@patternfly/react-core/dist/esm/components/Card/index.js";
import { KebabDropdown } from "cockpit-components-dropdown";
import { ListingTable, ListingTableRowProps, RowRecord } from "cockpit-components-table.jsx";
import cockpit from 'cockpit';

import { Config, Snapshot } from './types';
import { SnapshotDiff } from './snapshot_diff';
import { useDialogs } from 'dialogs';
import { CompareDialog } from './compare_dialog';
import { SortByDirection } from '@patternfly/react-table';
const _ = cockpit.gettext;

const RollbackDialog = ({ type, message }: { type: "success" | "error", message?: string }) => {
    const Dialogs = useDialogs();

    const reboot = () => {
        cockpit.spawn(["reboot"], { superuser: "require" });
    };

    return (
        <Modal
            variant="medium"
            position="top"
            onClose={() => Dialogs.close()}
            isOpen
        >
            <ModalHeader title={type === "success" ? _("Rolled back successfully") : _("There was an error")} />
            <ModalBody>
                {type === "success"
                    ? <p>{_("A reboot is needed to complete the rollback")}</p>
                    : <p>{message}</p>}
            </ModalBody>
            <ModalFooter>{type === "success" ? <Button onClick={reboot} variant="primary">{_("Reboot")}</Button> : ""}</ModalFooter>
        </Modal>
    );
};

export const DashboardPage = ({ hasSndiff, snapperConfigs, snapshots, snapshotsPaired }: { hasSndiff: boolean, snapperConfigs: Config[], snapshots: Snapshot[], snapshotsPaired: ([Snapshot, Snapshot] | [Snapshot])[] }) => {
    const Dialogs = useDialogs();
    const [expandedRows, setExpandedRows] = useState<RowRecord>({});

    const rollback = useCallback((snapshot: number) => {
        console.log("rolling back to", snapshot);
        cockpit.spawn(["snapper", "--json", "rollback", snapshot.toString()], { err: "message", superuser: "require" }).then(() => {
            Dialogs.show(<RollbackDialog type="success" />);
        })
                        .catch(err => {
                            console.log("Rollback errored with", err);
                            Dialogs.show(<RollbackDialog type="error" message={err} />);
                        });
    }, []);

    const diffButton = useMemo(() => {
        const button = (
            <Button
                key="compare-snapshots"
                isDisabled={!hasSndiff}
                onClick={() => Dialogs.show(<CompareDialog snapshots={snapshots} />)}
            >
                {_("Compare Snapshots")}
            </Button>
        );

        if (hasSndiff) {
            return button;
        }

        return (
            <Tooltip
                content={
                    <div>
                        {_("sndiff is not installed")}
                    </div>
                }
            >
                <div>
                    {button}
                </div>
            </Tooltip>
        );
    }, [hasSndiff, snapshots]);

    return (
        <PageSection>
            <Stack hasGutter>
                <Card>
                    <CardTitle>{_("Snapshot Configs")}</CardTitle>
                    <CardBody>
                        <ListingTable
                            columns={[
                                { title: "Config" },
                                { title: "Subvolume" },
                            ]} rows={snapperConfigs.map(config => {
                                return {
                                    columns: [
                                        {
                                            title: config.config,
                                        },
                                        {
                                            title: config.subvolume,
                                        },
                                    ],
                                    props: { key: config.config }
                                };
                            })}
                        />
                    </CardBody>
                </Card>
                <Card>
                    <CardHeader actions={
                        {
                            actions: [
                                diffButton
                            ]
                        }
                    }
                    >
                        <CardTitle>{_("Snapshots")}</CardTitle>
                    </CardHeader>
                    <CardBody>
                        <ListingTable
                            onExpand={(rows) => setExpandedRows(rows)}
                            columns={[
                                { title: "ID", sortable: true },
                                { title: "Type" },
                                { title: "Date", sortable: true, },
                                { title: "Description" },
                                { title: "User Data" },
                                { title: "Actions" },
                            ]}
                            sortMethod={(rows: ListingTableRowProps[], dir: SortByDirection, index: number) => {
                                rows.sort((a, b) => {
                                    if (a[index] < b[index]) return 1;
                                    if (a[index] > b[index]) return 1;
                                    return 0;
                                });
                                if (dir === "desc")  {
                                    return rows.reverse();
                                }
                                return rows;
                            }}
                            rows={snapshotsPaired.reduce((reduced_snapshots: ListingTableRowProps[], pairs: [Snapshot, Snapshot] | [Snapshot]) => {
                                const actions = (
                                    <KebabDropdown
                                        toggleButtonId="snapshot-actions"
                                        dropdownItems={
                                            pairs.length === 2
                                                ? [
                                                    <DropdownItem key={pairs[0].number.toString() + "-rollback-pre"} onClick={() => rollback(pairs[0].number)}>{_("Rollback to pre")}</DropdownItem>,
                                                    <DropdownItem key={pairs[1].number.toString() + "-rollback-post"} onClick={() => rollback(pairs[1].number)}>{_("Rollback to post")}</DropdownItem>
                                                ]
                                                : [
                                                    <DropdownItem key={pairs[0].number.toString() + "-rollback-single"} onClick={() => rollback(pairs[0].number)}>{_("Rollback to snapshot")}</DropdownItem>,
                                                ]
                                        }
                                    />
                                );

                                if (pairs[1]) {
                                    const pre = pairs[0];
                                    const post = pairs[1];
                                    const element: ListingTableRowProps = {
                                        columns: [
                                            {
                                                title: pre.number + " - " + post.number + (post.active && post.default ? " (Active + Default)" : post.active ? " (Active)" : post.default ? " (Default)" : ""),
                                            },
                                            {
                                                title: pre.type + " - " + post.type,
                                            },
                                            {
                                                title: pre.date,
                                            },
                                            {
                                                title: pre.description,
                                            },
                                            {
                                                title: JSON.stringify(pre.userdata),
                                            },
                                            {
                                                title: actions,
                                                props: { className: "pf-v6-c-table__action" }
                                            }
                                        ],
                                        props: { key: pre.number + "-" + post.number },
                                    };
                                    if (hasSndiff) {
                                        element.expandedContent = <SnapshotDiff pre_snapshot={pre.number} post_snapshot={post.number} load={expandedRows[pre.number + "-" + post.number] !== undefined} />;
                                    }
                                    reduced_snapshots.push(element);
                                } else {
                                    const snapshot = pairs[0];
                                    reduced_snapshots.push({
                                        columns: [
                                            {
                                                title: snapshot.number + (snapshot.active && snapshot.default ? " (Active + Default)" : snapshot.active ? " (Active)" : snapshot.default ? " (Default)" : ""),
                                            },
                                            {
                                                title: snapshot.type,
                                            },
                                            {
                                                title: snapshot.date,
                                            },
                                            {
                                                title: snapshot.description,
                                            },
                                            {
                                                title: JSON.stringify(snapshot.userdata),
                                            },
                                            {
                                                title: actions,
                                                props: { className: "pf-v6-c-table__action" }
                                            }
                                        ],
                                        props: { key: snapshot.number }
                                    });
                                }
                                return reduced_snapshots;
                            }, [])}
                        />
                    </CardBody>
                </Card>
            </Stack>
        </PageSection>
    );
};
